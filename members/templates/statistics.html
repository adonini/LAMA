{% extends 'login/base.html' %}
{% load static %}

{% block content %}
<div class="container mt-1">
    <!-- Row for Stats Overview and Histogram -->
    <div class="row">
        <!-- Stats Table Column (50% width) -->
        <div class="col-md-6">
            <!-- Total Members and Authors Overview -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card shadow text-center">
                        <div class="card-body">
                            <h5 class="card-title font-weight-bold">Total Members</h5>
                            <p class="card-text display-6">{{ total_members }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow text-center">
                        <div class="card-body">
                            <h5 class="card-title font-weight-bold">Total Authors</h5>
                            <p class="card-text display-6">{{ total_authors }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Members and Authors by Country Table -->
            <div class="table-responsive">
                <table class="table table-striped text-center">
                    <thead>
                        <tr>
                            <th>Country</th>
                            <th>Members</th>
                            <th>Authors</th>
                            <th>% of Total Members</th>
                            <th>% of Total Authors</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for data in countries_data %}
                        <tr>
                            <td>{{ data.country }}</td>
                            <td>{{ data.members_count }}</td>
                            <td>{{ data.authors_count }}</td>
                            <td>{{ data.member_percentage|floatformat:2 }}%</td>
                            <td>{{ data.author_percentage|floatformat:2 }}%</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <!-- Histogram Column (50% width) -->
        <div class="col-md-6">
            <!-- First row for the main chart -->
            <div class="card shadow text-center mb-4" style="height: auto;">
                <div class="card-body p-2"> <!-- Remove padding for tight fit -->
                    <h5 class="card-title font-weight-bold p-1">Avarage Members and Authors Over the Years</h5>

                    <!-- Country, Group, and Institute Selectors -->
                    <div class="dropdown-container" style="display: flex; gap: 1rem;">
                        <select id="countrySelector" class="form-select form-select-sm">
                            <option value="all">All Countries</option>
                            {% for country in country_list %}
                                <option value="{{ country }}">{{ country }}</option>
                            {% endfor %}
                        </select>

                        <select id="groupSelector" class="form-select form-select-sm" disabled>
                            <option value="">Select a Group</option>
                            {% for group in group_list %}
                                <option value="{{ group }}">{{ group }}</option>
                            {% endfor %}
                        </select>

                        <select id="instituteSelector" class="form-select form-select-sm" disabled>
                            <option value="">Select an Institute</option>
                            {% for institute in institute_list %}
                                <option value="{{ institute }}">{{ institute }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <canvas id="membersAuthorsHistogram"></canvas>
                </div>
            </div>

            <!-- Second row for the monthly averages chart -->
            <div class="card shadow text-center mb-4" style="height: auto;">
                <div class="card-body p-2"> <!-- Remove padding for tight fit -->
                    <h5 class="card-title font-weight-bold p-1">Members and Authors Average per Month</h5>

                    <!-- Year Selector -->
                    <select id="yearSelector" class="form-select mb-3">
                        <option value="" disabled>Select a Year</option>
                        {% for year in years_list %}
                            <option value="{{ year }}">{{ year }}</option>
                        {% endfor %}
                    </select>

                    <!-- Chart Container -->
                    <canvas id="monthlyMembersAuthorsHistogram"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        var members = {{ member_averages|safe }}.map(Math.round); // Yearly average members
        var authors = {{ author_averages|safe }}.map(Math.round); // Yearly average authors
        var currentYear = new Date().getFullYear();
        const chartData = {{ chart_data|safe }};
        const countrySelector = document.getElementById('countrySelector');
        const groupSelector = document.getElementById('groupSelector');
        const instituteSelector = document.getElementById('instituteSelector');

        // First chart (Average members and authors over the years)
        const ctx1 = document.getElementById('membersAuthorsHistogram').getContext('2d');
        const yearlyChart = new Chart(ctx1, {
            type: 'bar',
            data: {
                labels: years,
                datasets: [
                    {
                        label: 'Average Members Count',
                        data: members,
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        barPercentage: 0.4,
                        categoryPercentage: 1.0,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Average Authors Count',
                        data: authors,
                        backgroundColor: 'rgba(153, 102, 255, 0.6)',
                        barPercentage: 0.4,
                        categoryPercentage: 1.0,
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Year'
                        },
                        stacked: false, // Remove stacking for overlapping bars
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Count'
                        },
                        stacked: false // Remove stacking for overlapping bars
                    }
                },
                plugins: {
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                }
            }
        });

        // Function to update the chart
        function updateChart(selectedCountry, selectedGroup, selectedInstitute) {
            let updatedYears = years;
            let updatedMembers = [];
            let updatedAuthors = [];

            if (selectedCountry === "all" || !selectedCountry) {
                // Reset to general data
                updatedMembers = members; // General yearly members data
                updatedAuthors = authors; // General yearly authors data
            } else {
                const countryData = chartData.countries[selectedCountry] || {};

                // Use country-level data if no group or institute is selected
                updatedMembers = countryData.members || [];
                updatedAuthors = countryData.authors || [];

                if (selectedGroup) {
                    const groupData = countryData.groups[selectedGroup] || {};
                    updatedMembers = groupData.members || [];
                    updatedAuthors = groupData.authors || [];

                    if (selectedInstitute) {
                        const instituteData = groupData.institutes[selectedInstitute] || {};
                        updatedMembers = instituteData.members || [];
                        updatedAuthors = instituteData.authors || [];
                    }
                }
            }

            yearlyChart.data.labels = updatedYears;
            yearlyChart.data.datasets[0].data = updatedMembers;
            yearlyChart.data.datasets[1].data = updatedAuthors;
            yearlyChart.update();
        }

        // Add event listener to reset filters if "All" is selected
        countrySelector.addEventListener("change", function () {
            const selectedCountry = countrySelector.value;

            if (selectedCountry === "all") {
                groupSelector.disabled = true;
                instituteSelector.disabled = true;
                groupSelector.innerHTML = '<option value="">Select a Group</option>';
                instituteSelector.innerHTML = '<option value="">Select an Institute</option>';
            }

            const selectedGroup = "";
            const selectedInstitute = "";
            updateChart(selectedCountry, selectedGroup, selectedInstitute);
        });

        // Populate group dropdown based on country
        countrySelector.addEventListener("change", function () {
            const selectedCountry = countrySelector.value;
            const countryData = chartData.countries[selectedCountry] || {};

            // Update group dropdown
            groupSelector.disabled = !selectedCountry;
            groupSelector.innerHTML = '<option value="">Select a Group</option>';
            if (selectedCountry) {
                Object.keys(countryData.groups || {}).forEach((group) => {
                    const option = document.createElement("option");
                    option.value = group;
                    option.textContent = group;
                    groupSelector.appendChild(option);
                });
            }

            // Reset institute dropdown
            instituteSelector.disabled = true;
            instituteSelector.innerHTML = '<option value="">Select an Institute</option>';

            // Update chart
            updateChart(selectedCountry, "", "");
        });

        // Populate institute dropdown based on group
        groupSelector.addEventListener("change", function () {
            const selectedCountry = countrySelector.value;
            const selectedGroup = groupSelector.value;
            const groupData = chartData.countries[selectedCountry]?.groups[selectedGroup] || {};

            // Update institute dropdown
            instituteSelector.disabled = !selectedGroup;
            instituteSelector.innerHTML = '<option value="">Select an Institute</option>';
            if (selectedGroup) {
                Object.keys(groupData.institutes || {}).forEach((institute) => {
                    const option = document.createElement("option");
                    option.value = institute;
                    option.textContent = institute;
                    instituteSelector.appendChild(option);
                });
            }

            // Update chart
            updateChart(selectedCountry, selectedGroup, "");
        });

        // Update chart based on institute
        instituteSelector.addEventListener("change", function () {
            const selectedCountry = countrySelector.value;
            const selectedGroup = groupSelector.value;
            const selectedInstitute = instituteSelector.value;

            updateChart(selectedCountry, selectedGroup, selectedInstitute);
        });

        // Second chart (montlhy members and authors counts over each year)
        // Set default year in the dropdown
        var yearSelector = document.getElementById('yearSelector');
        if (years.includes(currentYear)) {
            yearSelector.value = currentYear;
            loadMonthlyChart(currentYear); // Call the function to load the chart for the default year
        }

        // Function to load the monthly chart
        function loadMonthlyChart(selectedYear) {
            const yearIndex = years.indexOf(selectedYear);
            if (yearIndex !== -1) {
                const monthlyMembers = monthlyMembersData[yearIndex];
                const monthlyAuthors = monthlyAuthorsData[yearIndex];

                // If the chart already exists, destroy it before creating a new one
                if (window.monthlyChart) {
                    window.monthlyChart.destroy();
                }

                const ctx2 = document.getElementById('monthlyMembersAuthorsHistogram').getContext('2d');
                window.monthlyChart = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                        datasets: [
                            {
                                label: 'Monthly Members Count',
                                data: monthlyMembers,
                                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                                barPercentage: 0.4,
                                categoryPercentage: 1.0,
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Monthly Authors Count',
                                data: monthlyAuthors,
                                backgroundColor: 'rgba(153, 102, 255, 0.6)',
                                barPercentage: 0.4,
                                categoryPercentage: 1.0,
                                borderColor: 'rgba(153, 102, 255, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Month'
                                },
                                stacked: false
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Count'
                                },
                                stacked: false
                            }
                        },
                        plugins: {
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        }
                    }
                });
            }
        }

        // Event listener for the dropdown selection
        yearSelector.addEventListener('change', function(e) {
            const selectedYear = parseInt(e.target.value);
            loadMonthlyChart(selectedYear);
        });
    });
</script>
{% endblock content %}