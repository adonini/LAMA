{% extends 'login/base.html' %}
{% load static %}

{% block content %}
<div class="container mt-1">
    <!-- Row for Stats Overview and Histogram -->
    <div class="row">
        <!-- Stats Table Column (50% width) -->
        <div class="col-md-7">
            <!-- Total Members and Authors Overview -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card shadow text-center">
                        <div class="card-body">
                            <h5 class="card-title font-weight-bold">Total Members</h5>
                            <p class="card-text display-6">{{ total_members }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow text-center">
                        <div class="card-body">
                            <h5 class="card-title font-weight-bold">Total Authors</h5>
                            <p class="card-text display-6">{{ total_authors }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Members and Authors by Country Table -->
            <!-- Tabs for Switching Between Countries and Groups -->
            <div class="nav nav-tabs" id="myTab" role="tablist">
                <a class="nav-link active" id="countries-tab" data-bs-toggle="tab" href="#countries" role="tab" aria-controls="countries" aria-selected="true">Countries</a>
                <a class="nav-link" id="groups-tab" data-bs-toggle="tab" href="#groups" role="tab" aria-controls="groups" aria-selected="false">Groups</a>
            </div>

            <!-- Tab Content -->
            <div class="tab-content" id="myTabContent">
                <!-- Countries Tab -->
                <div class="tab-pane fade show active" id="countries" role="tabpanel" aria-labelledby="countries-tab">
                    <div class="table-responsive">
                        <table class="table-stat table-striped text-center">
                            <thead>
                                <tr>
                                    <th>Country</th>
                                    <th>Members</th>
                                    <th>Authors</th>
                                    <th>% Members</th>
                                    <th>% Authors</th>
                                    <th>Avg Members last 12 Months</th>
                                    <th>Avg Authors last 12 Months</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for data in countries_data %}
                                <tr>
                                    <td>{{ data.country }}</td>
                                    <td>{{ data.members_count }}</td>
                                    <td>{{ data.authors_count }}</td>
                                    <td>{{ data.member_percentage|floatformat:2 }}%</td>
                                    <td>{{ data.author_percentage|floatformat:2 }}%</td>
                                    <td>{{ data.avg_members_12|floatformat:2 }}</td>
                                    <td>{{ data.avg_authors_12|floatformat:2 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Groups Tab -->
                <div class="tab-pane fade" id="groups" role="tabpanel" aria-labelledby="groups-tab">
                    <div class="table-responsive">
                        <table class="table-stat table-striped text-center">
                            <thead>
                                <tr>
                                    <th>Group</th>
                                    <th>Members</th>
                                    <th>Authors</th>
                                    <th>% Members</th>
                                    <th>% Authors</th>
                                    <th>Avg Members last 12 Months</th>
                                    <th>Avg Authors last 12 Months</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for data in groups_data %}
                                <tr>
                                    <td>{{ data.group }}</td>
                                    <td>{{ data.members_count }}</td>
                                    <td>{{ data.authors_count }}</td>
                                    <td>{{ data.member_percentage|floatformat:2 }}%</td>
                                    <td>{{ data.author_percentage|floatformat:2 }}%</td>
                                    <td>{{ data.avg_members_12|floatformat:2 }}</td>
                                    <td>{{ data.avg_authors_12|floatformat:2 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- Histogram Column (50% width) -->
        <div class="col-md-5">
            <!-- First row for the main chart -->
            <div class="card shadow text-center mb-4" style="height: auto;">
                <div class="card-body p-2"> <!-- Remove padding for tight fit -->
                    <h5 class="card-title font-weight-bold p-1">Avarage Members and Authors Over the Years</h5>

                    <!-- Country, Group, and Institute Selectors -->
                    <div class="dropdown-container" style="display: flex; gap: 1rem;">
                        <select id="countrySelector" class="form-select form-select-sm">
                            <option value="all">All Countries</option>
                            {% for country in country_list %}
                                <option value="{{ country }}">{{ country }}</option>
                            {% endfor %}
                        </select>

                        <select id="groupSelector" class="form-select form-select-sm" disabled>
                            <option value="">Select a Group</option>
                            {% for group in group_list %}
                                <option value="{{ group }}">{{ group }}</option>
                            {% endfor %}
                        </select>

                        <select id="instituteSelector" class="form-select form-select-sm" disabled>
                            <option value="">Select an Institute</option>
                            {% for institute in institute_list %}
                                <option value="{{ institute }}">{{ institute }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <canvas id="membersAuthorsHistogram"></canvas>
                </div>
            </div>

            <!-- Second row for the monthly averages chart -->
            <div class="card shadow text-center mb-4" style="height: auto;">
                <div class="card-body p-2"> <!-- Remove padding for tight fit -->
                    <h5 class="card-title font-weight-bold p-1">Members and Authors per Month</h5>

                    <!-- Year Selector -->
                    <select id="monthlyYearSelector" class="form-select form-select-sm mb-3">
                        <option value="" disabled>Select a Year</option>
                        {% for year in years_list %}
                            <option value="{{ year }}">{{ year }}</option>
                        {% endfor %}
                    </select>

                    <!-- Country, Group, and Institute Selectors -->
                    <div class="dropdown-container" style="display: flex; gap: 1rem;">
                        <select id="monthlyCountrySelector" class="form-select form-select-sm">
                            <option value="all">All Countries</option>
                            {% for country in country_list %}
                                <option value="{{ country }}">{{ country }}</option>
                            {% endfor %}
                        </select>

                        <select id="monthlyGroupSelector" class="form-select form-select-sm" disabled>
                            <option value="">Select a Group</option>
                            {% for group in group_list %}
                                <option value="{{ group }}">{{ group }}</option>
                            {% endfor %}
                        </select>

                        <select id="monthlyInstituteSelector" class="form-select form-select-sm" disabled>
                            <option value="">Select an Institute</option>
                            {% for institute in institute_list %}
                                <option value="{{ institute }}">{{ institute }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Chart Container -->
                    <canvas id="monthlyMembersAuthorsHistogram"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/html2canvas"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        var currentYear = new Date().getFullYear();
        var years = {{ years_list | safe}};

        const countrySelector = document.getElementById('countrySelector');
        const groupSelector = document.getElementById('groupSelector');
        const instituteSelector = document.getElementById('instituteSelector');
        // variables for monthly plot
        const chart_data_month = {{ chart_data_month | safe}};
        var monthlyMembersData = {{ default_monthly_members | safe}};
        var monthlyAuthorsData = {{ default_monthly_authors | safe}};
        const yearSelector_month = document.getElementById('monthlyYearSelector'); // Get the year selector
        const countrySelector_month = document.getElementById('monthlyCountrySelector');
        const groupSelector_month = document.getElementById('monthlyGroupSelector');
        const instituteSelector_month = document.getElementById('monthlyInstituteSelector'); {% endcomment %}
        ///////////////
        // First chart (Average members and authors over the years)
        ///////////////

        const ctx1 = document.getElementById('membersAuthorsHistogram').getContext('2d');
        const yearlyChart = new Chart(ctx1, {
            type: 'bar',
            data: {
                labels: years,
                datasets: [
                    {
                        label: 'Average Members Count',
                        data: [],
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        barPercentage: 1,
                        categoryPercentage: 0.8,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Average Authors Count',
                        data: [],
                        backgroundColor: 'rgba(153, 102, 255, 0.6)',
                        barPercentage: 1,
                        categoryPercentage: 0.8,
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Year'
                        },
                        stacked: false, // Remove stacking for overlapping bars
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Count'
                        },
                        stacked: false // Remove stacking for overlapping bars
                    }
                },
                plugins: {
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                }
            }
        });

        // Function to update chart with new data
        function updateChart(data) {
            yearlyChart.data.labels = data.years;
            yearlyChart.data.datasets[0].data = data.members;
            yearlyChart.data.datasets[1].data = data.authors;
            yearlyChart.update();
        }

        // Function to reset group and institute options
        function resetGroupAndInstituteSelectors() {
            // Reset and disable the group and institute dropdowns
            $('#groupSelector').html('<option value="">Select Group</option>').prop('disabled', true);
            $('#instituteSelector').html('<option value="">Select Institute</option>').prop('disabled', true);
        }

        // Function to update group options based on selected country
        function updateGroupOptions() {
            const selectedCountry = $('#countrySelector').val();  // Get selected country
            console.log("Selected country:", selectedCountry);  // Debugging line
            
            // Reset and disable the group selector if 'all' is selected
            if (selectedCountry === 'all') {
                resetGroupAndInstituteSelectors();
            } else {
                // Clear and disable the group selector initially
                $('#groupSelector').html('<option value="">Select Group</option>');
                $('#groupSelector').prop('disabled', true);

                // Fetch and populate groups based on the selected country
                $.ajax({
                    url: '/api/get-groups/',
                    data: { country: selectedCountry },
                    success: function(groups) {
                        console.log("Groups fetched:", groups);  // Debugging line
                        if (groups.length > 0) {
                            groups.forEach(group => {
                                const option = $('<option></option>').val(group).text(group);
                                $('#groupSelector').append(option);
                            });
                            $('#groupSelector').prop('disabled', false);  // Enable group dropdown

                            // If there is only one group, select it automatically
                            if (groups.length === 1) {
                                $('#groupSelector').val(groups[0]);
                                updateInstituteOptions();  // Automatically update institute options based on this selection
                            }
                        } else {
                            $('#groupSelector').prop('disabled', true);
                            alert("No groups found for the selected country.");
                        }
                    },
                    error: function() {
                        $('#groupSelector').prop('disabled', true);
                        console.log("Error loading groups with data:", { country: selectedCountry });
                        alert("Failed to load groups. Please try again.");
                    }
                });
            }
        }

        // Function to update institute options based on selected group
        function updateInstituteOptions() {
            const selectedGroup = $('#groupSelector').val();  // Get the selected group
            // Clear and disable the institute selector initially
            $('#instituteSelector').html('<option value="">Select Institute</option>');
            $('#instituteSelector').prop('disabled', true);  // Disable until institutes are loaded

            if (selectedGroup) {
                $.ajax({
                    url: '/api/get-institutes/',
                    data: { group: selectedGroup },
                    success: function(institutes) {
                        // Check if institutes are returned successfully
                        if (institutes.length > 0) {
                            institutes.forEach(institute => {
                                const option = $('<option></option>').val(institute).text(institute);
                                $('#instituteSelector').append(option);
                            });
                            $('#instituteSelector').prop('disabled', false);  // Enable institute dropdown

                            // If there is only one institute, select it automatically
                            if (institutes.length === 1) {
                                $('#instituteSelector').val(institutes[0]);
                            }
                        } else {
                            $('#instituteSelector').prop('disabled', true);  // Keep disabled if no institutes are found
                            alert("No institutes found for the selected group.");
                        }
                    },
                    error: function() {
                        $('#instituteSelector').prop('disabled', true);  // Keep disabled if request fails
                        alert("Failed to load institutes. Please try again.");
                    }
                });
            } else {
                $('#instituteSelector').prop('disabled', true);  // Disable institute selector if no group is selected
            }
        }

        // Function to fetch and update data based on selected filters
        function updateFilteredData() {
            const country = $('#countrySelector').val() || 'all'; // Default 'all' for country
            const group = $('#groupSelector').val() || null; // Default null for group
            const institute = $('#instituteSelector').val() || null; // Default null for institute

            $.ajax({
                url: '/api/get_filtered_chart_data/',  // API endpoint for filtered data
                data: { country: country, group: group, institute: institute },
                success: function(data) {
                    updateChart(data);  // Update chart with new data
                },
                error: function() {
                    alert("Failed to fetch filtered data. Please try again.");
                }
            });
        }

        // Event listeners for dropdowns
        $('#countrySelector').change(function() {
            const selectedCountry = $('#countrySelector').val();
            
            // Reset and disable group and institute selectors when the country is changed
            resetGroupAndInstituteSelectors();

            if (selectedCountry !== 'all') {
                updateGroupOptions();  // Update group options based on selected country
            }

            updateFilteredData();  // Update data based on the selected filters
        });

        $('#groupSelector').change(function() {
            updateInstituteOptions();  // Update institute options based on selected group
            updateFilteredData();  // Update data based on selected filters
        });

        $('#instituteSelector').change(function() {
            updateFilteredData();  // Update data based on selected institute
        });

        // Trigger update when the page loads with default filters (show all data)
        $(document).ready(function() {
            updateFilteredData();  // Fetch and update chart with default data (for all countries)
            updateGroupOptions();  // Update group options
            updateInstituteOptions();  // Update institute options
        });

        // Second chart (montlhy members and authors counts over each year)
        ///////////////

        // Set default data using the current year and "all" filters
        const defaultYearData = chart_data_month[currentYear] || {};
        const defaultMonthlyMembers = defaultYearData.countries?.all?.members || [];
        const defaultMonthlyAuthors = defaultYearData.countries?.all?.authors || [];

        const ctx2 = document.getElementById('monthlyMembersAuthorsHistogram').getContext('2d');
        const monthlyChart = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                datasets: [
                    {
                        label: 'Monthly Members Count',
                        data: monthlyMembersData,
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        barPercentage: 1,
                        categoryPercentage: 0.8,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Monthly Authors Count',
                        data: monthlyAuthorsData,
                        backgroundColor: 'rgba(153, 102, 255, 0.6)',
                        barPercentage: 1,
                        categoryPercentage: 0.8,
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Month'
                        },
                        stacked: false
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Count'
                        },
                        stacked: false
                    }
                },
                plugins: {
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                }
            }
        });

        // Function to update monthly chart based on filters
        function updateMonthlyChart(selectedYear, selectedCountry, selectedGroup, selectedInstitute) {
            const yearData = chart_data_month[selectedYear] || {};
            let monthlyMembers = [];
            let monthlyAuthors = [];
        
            // Apply filters step by step
            if (selectedCountry === "all" || !selectedCountry) {
                monthlyMembers = monthlyMembersData;
                monthlyAuthors = monthlyAuthorsData;
            } else {
                const countryData = yearData.countries[selectedCountry] || {};

                if (selectedGroup) {
                    const groupData = countryData.groups[selectedGroup] || {};
                    monthlyMembers = groupData.members || [];
                    monthlyAuthors = groupData.authors || [];
        
                    if (selectedInstitute) {
                        const instituteData = groupData.institutes[selectedInstitute] || {};
                        monthlyMembers = instituteData.members || [];
                        monthlyAuthors = instituteData.authors || [];
                    }
                } else {
                    monthlyMembers = countryData.members || [];
                    monthlyAuthors = countryData.authors || [];
                }
            }
        
            // Update the chart
            monthlyChart.data.datasets[0].data = monthlyMembers;
            monthlyChart.data.datasets[1].data = monthlyAuthors;
            monthlyChart.update();
        }

        // Populate dropdowns based on selections
        function updateDropdowns(selectedYear, selectedCountry, selectedGroup) {
            const yearData = chart_data_month[selectedYear] || {};
            const countryData = yearData.countries[selectedCountry] || {};

            // Update group dropdown
            groupSelector_month.disabled = !selectedCountry;
            groupSelector_month.innerHTML = '<option value="">Select a Group</option>';
            if (selectedCountry) {
                Object.keys(countryData.groups || {}).forEach((group) => {
                    const option = document.createElement("option");
                    option.value = group;
                    option.textContent = group;
                    groupSelector_month.appendChild(option);
                });
            }

            // Update institute dropdown
            const groupData = countryData.groups[selectedGroup] || {};
            instituteSelector_month.disabled = !selectedGroup;
            instituteSelector_month.innerHTML = '<option value="">Select an Institute</option>';
            if (selectedGroup) {
                Object.keys(groupData.institutes || {}).forEach((institute) => {
                    const option = document.createElement("option");
                    option.value = institute;
                    option.textContent = institute;
                    instituteSelector_month.appendChild(option);
                });
            }
        }

        // Event listener for year selection
        yearSelector_month.addEventListener("change", function () {
            const selectedYear = yearSelector_month.value;
            const selectedCountry = countrySelector_month.value || "all";
            const selectedGroup = groupSelector_month.value;
            const selectedInstitute = instituteSelector_month.value;

            // Reset filters
            countrySelector_month.value = "all";
            groupSelector_month.innerHTML = '<option value="">Select a Group</option>';
            instituteSelector_month.innerHTML = '<option value="">Select an Institute</option>';
            groupSelector_month.disabled = true;
            instituteSelector_month.disabled = true;

            // Update chart and dropdowns
            updateMonthlyChart(selectedYear, selectedCountry, selectedGroup, selectedInstitute);
        });

        // Event listener for country selection
        countrySelector_month.addEventListener("change", function () {
            const selectedYear = yearSelector_month.value;
            const selectedCountry = countrySelector_month.value;
            const selectedGroup = "";
            const selectedInstitute = "";

            updateDropdowns(selectedYear, selectedCountry, selectedGroup);
            updateMonthlyChart(selectedYear, selectedCountry, selectedGroup, selectedInstitute);
        });

        // Event listener for group selection
        groupSelector_month.addEventListener("change", function () {
            const selectedYear = yearSelector_month.value;
            const selectedCountry = countrySelector_month.value;
            const selectedGroup = groupSelector_month.value;
            const selectedInstitute = "";

            updateDropdowns(selectedYear, selectedCountry, selectedGroup);
            updateMonthlyChart(selectedYear, selectedCountry, selectedGroup, selectedInstitute);
        });

        // Event listener for institute selection
        instituteSelector_month.addEventListener("change", function () {
            const selectedYear = yearSelector_month.value;
            const selectedCountry = countrySelector_month.value;
            const selectedGroup = groupSelector_month.value;
            const selectedInstitute = instituteSelector_month.value;

            updateMonthlyChart(selectedYear, selectedCountry, selectedGroup, selectedInstitute);
        });

        // Set default dropdown values and initialize chart
        yearSelector_month.value = currentYear;
        countrySelector_month.value = "all";
        groupSelector_month.disabled = true;
        instituteSelector_month.disabled = true;

        updateMonthlyChart(currentYear, "all");
    });
</script>
{% endblock content %}